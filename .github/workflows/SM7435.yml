name: Cosmic Kernel CI-Garnet

on:
  workflow_dispatch:

jobs:
  Kernel_Build_CI:
    name: Cosmic Kernel Build
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Initial Setup & Titan Trigger
        run: |
          # Core Dependencies
          sudo apt-get update -qq && sudo apt-get install -y jq
          
          # Time & Build ID Configuration
          sudo timedatectl set-timezone Asia/Kolkata
          echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
          START_DATE=$(date '+%Y-%m-%d %I:%M %p')
          echo "START_DATE=$START_DATE" >> $GITHUB_ENV
          
          # Build ID starts from 1 based on run_number
          BID="CK-${{ github.run_number }}"
          echo "BID=$BID" >> $GITHUB_ENV
          
          # High-End Professional Initial Trigger
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" -d parse_mode="HTML" \
            -d text="âœ¨ <b>COSMIC KERNEL | GARNET</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“%0Aâ”ƒ ğŸ‘¤ <b>Operator:</b> <code>${{ github.actor }}</code>%0Aâ”ƒ ğŸ†” <b>Build ID:</b> <code>$BID</code>%0Aâ”ƒ ğŸ•’ <b>Triggered:</b> <code>$START_DATE</code>%0Aâ”ƒ ğŸ›°ï¸ <b>Status:</b> ğŸ—ï¸ Initializing...%0Aâ”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›%0A[â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 0%")
          
          MSG_ID=$(echo $RESPONSE | jq '.result.message_id')
          echo "MSG_ID=$MSG_ID" >> $GITHUB_ENV

      - name: Maximize Space & Swap
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/editMessageText" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" -d message_id="${{ env.MSG_ID }}" -d parse_mode="HTML" \
            -d text="âœ¨ <b>COSMIC KERNEL | GARNET</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“%0Aâ”ƒ ğŸ‘¤ <b>Operator:</b> <code>${{ github.actor }}</code>%0Aâ”ƒ ğŸ†” <b>Build ID:</b> <code>${{ env.BID }}</code>%0Aâ”ƒ âš™ï¸ <b>Step:</b> Resource Optimization%0Aâ”ƒ ğŸ›°ï¸ <b>Status:</b> Expanding Swap%0Aâ”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›%0A[â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 10%"
          
          # Fix for 'Text file busy': Turn off existing swap
          sudo swapoff -a || true
          sudo rm -f /swapfile
          sudo fallocate -l 10G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Checkout & Clone
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/editMessageText" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" -d message_id="${{ env.MSG_ID }}" -d parse_mode="HTML" \
            -d text="âœ¨ <b>COSMIC KERNEL | GARNET</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“%0Aâ”ƒ ğŸ‘¤ <b>Operator:</b> <code>${{ github.actor }}</code>%0Aâ”ƒ ğŸ†” <b>Build ID:</b> <code>${{ env.BID }}</code>%0Aâ”ƒ ğŸ“‚ <b>Step:</b> Git Syncing%0Aâ”ƒ ğŸ›°ï¸ <b>Status:</b> Cloning Sources%0Aâ”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›%0A[â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 25%"
          
          git clone https://github.com/CosmicCoreX/android_kernel_xiaomi_sm7435 --depth=1 -b lineage-23.0 kernel
          git clone https://github.com/CosmicCoreX/android_kernel_xiaomi_sm7435-modules --depth=1 -b lineage-23.0 kernel/kernel/xiaomi/sm7435-modules
          cd kernel && echo "COMMIT_ID=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Setup Toolchain & Build
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/editMessageText" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" -d message_id="${{ env.MSG_ID }}" -d parse_mode="HTML" \
            -d text="âœ¨ <b>COSMIC KERNEL | GARNET</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“%0Aâ”ƒ ğŸ‘¤ <b>Operator:</b> <code>${{ github.actor }}</code>%0Aâ”ƒ ğŸ†” <b>Build ID:</b> <code>${{ env.BID }}</code>%0Aâ”ƒ ğŸ”¨ <b>Step:</b> Kernel Compilation%0Aâ”ƒ ğŸ›°ï¸ <b>Status:</b> Active Clang Build%0Aâ”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›%0A[â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘] 60%"
          
          git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 --depth=1 -b main clang-repo
          mkdir clang && mv clang-repo/clang-r522817/* clang/ && rm -rf clang-repo
          export PATH=$(pwd)/clang/bin:$PATH
          cd kernel
          MAKE_ARGS="ARCH=arm64 CC=clang NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip LD=ld.lld CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- LLVM=1 LLVM_IAS=1"
          make O=out $MAKE_ARGS gki_defconfig vendor/garnet_GKI.config
          make -j$(nproc --all) O=out $MAKE_ARGS 2>&1 | tee ../build_log.txt
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/editMessageText" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" -d message_id="${{ env.MSG_ID }}" -d parse_mode="HTML" \
            -d text="âœ¨ <b>COSMIC KERNEL | GARNET</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“%0Aâ”ƒ ğŸ‘¤ <b>Operator:</b> <code>${{ github.actor }}</code>%0Aâ”ƒ ğŸ†” <b>Build ID:</b> <code>${{ env.BID }}</code>%0Aâ”ƒ ğŸŒ¿ <b>Step:</b> DTB & Modules Build%0Aâ”ƒ ğŸ›°ï¸ <b>Status:</b> Finalizing Binary%0Aâ”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›%0A[â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘] 85%"
          
          make -j$(nproc --all) O=out $MAKE_ARGS dtbs 2>&1 | tee -a ../build_log.txt
          make -j$(nproc --all) O=out $MAKE_ARGS modules 2>&1 | tee -a ../build_log.txt

      - name: Packaging
        if: success()
        run: |
          mkdir -p output
          cp kernel/out/arch/arm64/boot/Image output/
          find kernel/out/arch/arm64/boot -name "dtbo.img" -exec cp {} output/ \;
          find kernel/out -name "*.ko" -exec cp {} output/ \;
          cd output && zip -r9 ../Cosmic-Kernel-Garnet.zip *
          cd ..
          echo "MD5_HASH=$(md5sum Cosmic-Kernel-Garnet.zip | cut -d' ' -f1)" >> $GITHUB_ENV

      - name: Final Delivery
        if: success()
        run: |
          CUR_TIME=$(date +%s)
          DIFF=$(( CUR_TIME - START_TIME ))
          DURATION="$(( DIFF / 60 ))m $(( DIFF % 60 ))s"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/editMessageText" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" -d message_id="${{ env.MSG_ID }}" -d parse_mode="HTML" \
            -d text="ğŸ <b>BUILD COMPLETE</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“%0Aâ”ƒ âœ… <b>Result:</b> Success%0Aâ”ƒ â±ï¸ <b>Duration:</b> <code>$DURATION</code>%0Aâ”ƒ ğŸ‘¤ <b>Operator:</b> <code>${{ github.actor }}</code>%0Aâ”ƒ ğŸ†” <b>Build ID:</b> <code>${{ env.BID }}</code>%0Aâ”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›%0A[â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%"
          
          curl -F chat_id="${{ secrets.TG_CHAT_ID }}" -F document=@"Cosmic-Kernel-Garnet.zip" \
          -F caption="ğŸ <b>Cosmic Kernel Ready!</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AğŸ†” <b>Commit:</b> <code>${{ env.COMMIT_ID }}</code>%0AğŸ”‘ <b>MD5:</b> <code>${{ env.MD5_HASH }}</code>%0AğŸ‘¤ <b>Built by:</b> ${{ github.actor }}" \
          -F parse_mode="HTML" "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument"

      - name: Cancellation Handler
        if: cancelled()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/editMessageText" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" -d message_id="${{ env.MSG_ID }}" -d parse_mode="HTML" \
            -d text="ğŸ›‘ <b>BUILD CANCELLED</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“%0Aâ”ƒ ğŸ‘¤ <b>Operator:</b> <code>${{ github.actor }}</code>%0Aâ”ƒ ğŸ†” <b>Build ID:</b> <code>${{ env.BID }}</code>%0Aâ”ƒ ğŸ•’ <b>Time:</b> <code>$(date '+%I:%M %p')</code>%0Aâ”ƒ âš ï¸ <b>Status:</b> Terminated by User%0Aâ”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"

      - name: Failure Handler
        if: failure()
        run: |
          [ -f build_log.txt ] && tail -n 250 build_log.txt > error.txt || echo "Crash before logs." > error.txt
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/editMessageText" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" -d message_id="${{ env.MSG_ID }}" -d parse_mode="HTML" \
            -d text="ğŸš¨ <b>BUILD FAILED</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“%0Aâ”ƒ ğŸ‘¤ <b>Operator:</b> <code>${{ github.actor }}</code>%0Aâ”ƒ ğŸ†” <b>Build ID:</b> <code>${{ env.BID }}</code>%0Aâ”ƒ ğŸ•’ <b>Time:</b> <code>$(date '+%I:%M %p')</code>%0Aâ”ƒ âš ï¸ <b>Log:</b> Sending Trace...%0Aâ”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
          
          curl -F chat_id="${{ secrets.TG_CHAT_ID }}" -F document=@"error.txt" \
          -F caption="âŒ <b>Build Trace Attached</b>%0ACheck the end of this file for the error." \
          -F parse_mode="HTML" "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument"